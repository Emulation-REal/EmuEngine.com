<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>EmuEngine.com - Better Browser Experience</title>
<style>
  /* Reset & base */
  body, html {
    margin: 0; padding: 0; height: 100vh;
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    display: flex; flex-direction: column;
    background-color: var(--bg);
    color: var(--fg);
    --bg-light: #f0f0f5;
    --fg-light: #222;
    --bg-dark: #121212;
    --fg-dark: #eee;
    --accent: #4c8cff;
    --accent-dark: #3672f0;
  }
  /* Theme vars default to light */
  body.light {
    --bg: var(--bg-light);
    --fg: var(--fg-light);
    --accent-current: var(--accent);
  }
  body.dark {
    --bg: var(--bg-dark);
    --fg: var(--fg-dark);
    --accent-current: var(--accent-dark);
  }

  /* Container flex for full height */
  #app {
    flex: 1;
    display: flex;
    flex-direction: column;
  }

  /* Controls top bar */
  #controls {
    background: var(--bg);
    padding: 8px 12px;
    display: flex;
    align-items: center;
    gap: 6px;
    border-bottom: 1px solid var(--accent-current);
  }

  button, input[type="text"] {
    font-size: 15px;
  }

  button {
    background: var(--accent-current);
    border: none;
    border-radius: 4px;
    color: white;
    padding: 6px 12px;
    cursor: pointer;
    user-select: none;
    transition: background-color 0.3s ease;
  }
  button:hover {
    background: var(--accent);
  }
  button:disabled {
    background: #888;
    cursor: default;
  }

  input[type="text"] {
    flex-grow: 1;
    padding: 6px 10px;
    border: 1px solid var(--accent-current);
    border-radius: 4px;
    color: var(--fg);
    background-color: var(--bg);
    outline-offset: 2px;
  }

  /* Tab bar */
  #tab-bar {
    background: var(--bg);
    display: flex;
    border-bottom: 1px solid var(--accent-current);
    overflow-x: auto;
  }
  .tab {
    flex-shrink: 0;
    padding: 6px 12px;
    cursor: pointer;
    user-select: none;
    border-right: 1px solid var(--accent-current);
    color: var(--fg);
    background: var(--bg);
    display: flex;
    align-items: center;
    gap: 6px;
  }
  .tab.active {
    background: var(--accent-current);
    color: white;
    font-weight: bold;
  }
  .tab .close-btn {
    background: transparent;
    border: none;
    font-weight: bold;
    color: inherit;
    cursor: pointer;
    padding: 0 4px;
    font-size: 14px;
  }

  /* Bookmark dropdown */
  #bookmark-list {
    position: absolute;
    background: var(--bg);
    border: 1px solid var(--accent-current);
    margin-top: 2px;
    max-height: 150px;
    overflow-y: auto;
    width: 300px;
    display: none;
    z-index: 10;
  }
  #bookmark-list div {
    padding: 6px 8px;
    cursor: pointer;
  }
  #bookmark-list div:hover {
    background: var(--accent-current);
    color: white;
  }

  /* Iframe container */
  #iframe-container {
    flex-grow: 1;
    position: relative;
  }

  iframe {
    border: none;
    width: 100%;
    height: 100%;
  }

  /* Theme toggle */
  #theme-toggle {
    background: none;
    color: var(--accent-current);
    border: 1px solid var(--accent-current);
    padding: 6px 10px;
    border-radius: 4px;
  }
  #theme-toggle:hover {
    background: var(--accent-current);
    color: white;
  }
</style>
</head>
<body class="light">

<div id="app">
  <div id="controls">
    <button id="backBtn" title="Back">&lt;</button>
    <button id="forwardBtn" title="Forward">&gt;</button>
    <input list="url-suggestions" id="urlInput" type="text" placeholder="Enter URL or search..." autocomplete="off" spellcheck="false" />
    <datalist id="url-suggestions"></datalist>
    <button id="goBtn">Go</button>
    <button id="bookmarkBtn" title="Add Bookmark">★</button>
    <button id="theme-toggle" title="Toggle Light/Dark">Dark Mode</button>
  </div>
  <div id="bookmark-list"></div>
  <div id="tab-bar"></div>
  <div id="iframe-container"></div>
</div>

<script>
(() => {
  const app = document.getElementById('app');
  const backBtn = document.getElementById('backBtn');
  const forwardBtn = document.getElementById('forwardBtn');
  const goBtn = document.getElementById('goBtn');
  const urlInput = document.getElementById('urlInput');
  const bookmarkBtn = document.getElementById('bookmarkBtn');
  const themeToggle = document.getElementById('theme-toggle');
  const bookmarkList = document.getElementById('bookmark-list');
  const urlSuggestions = document.getElementById('url-suggestions');
  const tabBar = document.getElementById('tab-bar');
  const iframeContainer = document.getElementById('iframe-container');

  // State
  let tabs = [];
  let currentTabId = null;
  let theme = localStorage.getItem('emuengine-theme') || 'light';

  // --- Helpers ---

  function isValidUrl(str) {
    try {
      new URL(str);
      return true;
    } catch (_) {
      return false;
    }
  }

  function normalizeUrl(url) {
    if (!url) return '';
    url = url.trim();
    if (url === '') return '';
    if (!url.match(/^https?:\/\//i)) {
      url = 'https://' + url;
    }
    return url;
  }

  // --- History per tab ---

  function createTab(url = 'https://example.com') {
    const id = Date.now() + Math.random().toString(36).slice(2);
    const tab = {
      id,
      history: [url],
      historyIndex: 0,
      bookmarks: loadBookmarks(),
    };
    tabs.push(tab);
    createTabUI(tab);
    switchTab(id);
    saveTabs();
    return tab;
  }

  function createTabUI(tab) {
    const tabEl = document.createElement('div');
    tabEl.classList.add('tab');
    tabEl.dataset.id = tab.id;
    tabEl.textContent = 'Loading...';

    const closeBtn = document.createElement('button');
    closeBtn.textContent = '×';
    closeBtn.className = 'close-btn';
    closeBtn.title = 'Close tab';

    closeBtn.addEventListener('click', (e) => {
      e.stopPropagation();
      closeTab(tab.id);
    });

    tabEl.appendChild(closeBtn);

    tabEl.addEventListener('click', () => {
      switchTab(tab.id);
    });

    tabBar.appendChild(tabEl);
  }

  function updateTabUI(tab) {
    const tabEl = tabBar.querySelector(`.tab[data-id="${tab.id}"]`);
    if (!tabEl) return;
    const url = tab.history[tab.historyIndex];
    tabEl.childNodes[0].textContent = new URL(url).hostname || url;
  }

  function switchTab(id) {
    if (currentTabId === id) return;
    currentTabId = id;
    tabs.forEach(t => {
      const tabEl = tabBar.querySelector(`.tab[data-id="${t.id}"]`);
      if (t.id === id) tabEl.classList.add('active');
      else tabEl.classList.remove('active');
    });
    loadCurrentTabUrl();
  }

  function closeTab(id) {
    const idx = tabs.findIndex(t => t.id === id);
    if (idx === -1) return;
    tabs.splice(idx, 1);

    const tabEl = tabBar.querySelector(`.tab[data-id="${id}"]`);
    if (tabEl) tabEl.remove();

    if (currentTabId === id) {
      if (tabs.length > 0) {
        switchTab(tabs[Math.max(0, idx - 1)].id);
      } else {
        // No tabs left - create new
        createTab('https://example.com');
      }
    }
    saveTabs();
  }

  function loadCurrentTabUrl() {
    const tab = tabs.find(t => t.id === currentTabId);
    if (!tab) return;
    const url = tab.history[tab.historyIndex];
    urlInput.value = url;
    loadUrl(url);
    updateNavButtons();
    updateTabUI(tab);
  }

  // --- Navigation ---

  function navigate(url) {
    const tab = tabs.find(t => t.id === currentTabId);
    if (!tab) return;
    url = normalizeUrl(url);
    if (!url) return;
    // If navigating from historyIndex in middle, truncate forward history
    if (tab.historyIndex < tab.history.length - 1) {
      tab.history = tab.history.slice(0, tab.historyIndex + 1);
    }
    tab.history.push(url);
    tab.historyIndex++;
    saveTabs();
    loadCurrentTabUrl();
  }

  backBtn.onclick = () => {
    const tab = tabs.find(t => t.id === currentTabId);
    if (!tab) return;
    if (tab.historyIndex > 0) {
      tab.historyIndex--;
      saveTabs();
      loadCurrentTabUrl();
    }
  };

  forwardBtn.onclick = () => {
    const tab = tabs.find(t => t.id === currentTabId);
    if (!tab) return;
    if (tab.historyIndex < tab.history.length - 1) {
      tab.historyIndex++;
      saveTabs();
      loadCurrentTabUrl();
    }
  };

  goBtn.onclick = () => {
    navigate(urlInput.value.trim());
  };

  urlInput.addEventListener('keydown', (e) => {
    if (e.key === 'Enter') {
      navigate(urlInput.value.trim());
    }
  });

  // --- Load URL into iframe ---

  function loadUrl(url) {
    iframeContainer.innerHTML = '';
    const iframe = document.createElement('iframe');
    iframe.src = url;
    iframeContainer.appendChild(iframe);
  }

  // --- Update buttons state ---

  function updateNavButtons() {
    const tab = tabs.find(t => t.id === currentTabId);
    if (!tab) {
      backBtn.disabled = true;
      forwardBtn.disabled = true;
      return;
    }
    backBtn.disabled = tab.historyIndex <= 0;
    forwardBtn.disabled = tab.historyIndex >= tab.history.length - 1;
  }

  // --- Bookmarks ---

  function loadBookmarks() {
    const bm = localStorage.getItem('emuengine-bookmarks');
    return bm ? JSON.parse(bm) : [];
  }

  function saveBookmarks(bookmarks) {
    localStorage.setItem('emuengine-bookmarks', JSON.stringify(bookmarks));
  }

  function addBookmark(url) {
    const bookmarks = loadBookmarks();
    if (!bookmarks.find(b => b.url === url)) {
      bookmarks.push({ url, title: url });
      saveBookmarks(bookmarks);
      updateBookmarkSuggestions();
    }
  }

  function removeBookmark(url) {
    let bookmarks = loadBookmarks();
    bookmarks = bookmarks.filter(b => b.url !== url);
    saveBookmarks(bookmarks);
    updateBookmarkSuggestions();
  }

  // Show bookmarks in dropdown list under input
  function showBookmarkList() {
    const bookmarks = loadBookmarks();
    if (bookmarks.length === 0) {
      bookmarkList.style.display = 'none';
      return;
    }
    bookmarkList.innerHTML = '';
    bookmarks.forEach(bm => {
      const div = document.createElement('div');
      div.textContent = bm.url;
      div.title = bm.url;
      div.addEventListener('click', () => {
        navigate(bm.url);
        bookmarkList.style.display = 'none';
      });
      bookmarkList.appendChild(div);
    });
    const rect = urlInput.getBoundingClientRect();
    bookmarkList.style.left = rect.left + 'px';
    bookmarkList.style.top = rect.bottom + 'px';
    bookmarkList.style.display = 'block';
  }

  bookmarkBtn.onclick = () => {
    const url = normalizeUrl(urlInput.value);
    if (url) {
      addBookmark(url);
      alert(`Added bookmark: ${url}`);
    }
  };

  urlInput.addEventListener('focus', () => {
    showBookmarkList();
  });

  urlInput.addEventListener('blur', () => {
    // Delay hiding so click on bookmark works
    setTimeout(() => {
      bookmarkList.style.display = 'none';
    }, 200);
  });

  // Update datalist for autocomplete based on bookmarks
  function updateBookmarkSuggestions() {
    const bookmarks = loadBookmarks();
    urlSuggestions.innerHTML = '';
    bookmarks.forEach(bm => {
      const option = document.createElement('option');
      option.value = bm.url;
      urlSuggestions.appendChild(option);
    });
  }

  // --- Tabs ---

  // Add new tab button
  const newTabBtn = document.createElement('button');
  newTabBtn.textContent = '+';
  newTabBtn.title = 'New Tab';
  newTabBtn.style.marginLeft = 'auto';
  newTabBtn.style.background = 'var(--accent-current)';
  newTabBtn.style.color = 'white';
  newTabBtn.style.fontWeight = 'bold';
  newTabBtn.style.borderRadius = '0 4px 4px 0';
  newTabBtn.style.border = 'none';
  newTabBtn.style.cursor = 'pointer';
  newTabBtn.style.padding = '6px 12px';
  tabBar.appendChild(newTabBtn);

  newTabBtn.onclick = () => {
    createTab('https://example.com');
  };

  // --- Theme toggle ---

  function applyTheme() {
    document.body.className = theme;
    themeToggle.textContent = theme === 'light' ? 'Dark Mode' : 'Light Mode';
    // Update colors of dynamic elements
    newTabBtn.style.background = getComputedStyle(document.body).getPropertyValue('--accent-current').trim();
  }

  themeToggle.onclick = () => {
    theme = theme === 'light' ? 'dark' : 'light';
    localStorage.setItem('emuengine-theme', theme);
    applyTheme();
  };

  // --- LocalStorage tabs save/load ---

  function saveTabs() {
    const saveData = tabs.map(t => ({
      id: t.id,
      history: t.history,
      historyIndex: t.historyIndex,
    }));
    localStorage.setItem('emuengine-tabs', JSON.stringify(saveData));
    localStorage.setItem('emuengine-currentTabId', currentTabId);
  }

  function loadTabs() {
    const saveData = localStorage.getItem('emuengine-tabs');
    if (!saveData) return false;
    try {
      const parsed = JSON.parse(saveData);
      tabs = parsed.map(t => ({
        id: t.id,
        history: t.history,
        historyIndex: t.historyIndex,
      }));
      currentTabId = localStorage.getItem('emuengine-currentTabId') || (tabs[0] && tabs[0].id);
      // Rebuild UI
      tabBar.innerHTML = '';
      tabs.forEach(t => createTabUI(t));
      tabBar.appendChild(newTabBtn);
      if (currentTabId) {
        switchTab(currentTabId);
      }
      return true;
    } catch {
      return false;
    }
  }

  // --- Initialize ---

  updateBookmarkSuggestions();
  applyTheme();

  if (!loadTabs()) {
    createTab('https://example.com');
  }

  // Close bookmark list on resize or scroll
  window.addEventListener('resize', () => {
    bookmarkList.style.display = 'none';
  });
  window.addEventListener('scroll', () => {
    bookmarkList.style.display = 'none';
  });

})();
</script>

</body>
</html>
